<div class="dashboard-page">
  <canvas #particlesCanvas class="particles-canvas"></canvas>

  <header class="top-bar">
    <div class="brand">
      <img src="focus-flow-logo.png" alt="FocusFlow" class="logo" />
      <span class="title">FocusFlow</span>
    </div>
    <div class="user-actions">
      <!-- placeholder: you'll hook real user data later -->
      <span class="welcome">Welcome back ðŸ‘‹</span>
      <button class="ghost-btn" routerLink="/login">Logout</button>
    </div>
  </header>

  <main class="dashboard-layout">
    <!-- LEFT COLUMN: Start Session -->
    <section
      class="panel focus-panel"
      *ngIf="!isInSession; else sessionActiveTemplate"
    >
      <div class="panel-header">
        <h2>Start a Focus Session</h2>
        <p>
          Choose what you want to work on, how you feel, and let FocusFlow match
          you with the right soundtrack.
        </p>
      </div>

      <div class="error-message" *ngIf="apiError">
        {{ apiError }}
      </div>

      <form
        [formGroup]="sessionForm"
        (ngSubmit)="onStartSession()"
        class="focus-form"
      >
        <div class="form-group">
          <label for="activity">What do you want to work on?</label>
          <select id="activity" formControlName="activityId">
            <option [ngValue]="null" disabled>Select an activity...</option>
            <option *ngFor="let activity of activities" [value]="activity.id">
              {{ activity.name }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="mood">How do you feel?</label>
          <select id="mood" formControlName="mood">
            <option value="Motivated">Motivated</option>
            <option value="Tired">Tired</option>
            <option value="Stressed">Stressed</option>
            <option value="Creative">Creative</option>
          </select>
        </div>

        <div class="form-group">
          <label for="duration">Duration</label>
          <select id="duration" formControlName="durationMinutes">
            <option value="25">25 min (Pomodoro)</option>
            <option value="45">45 min</option>
            <option value="60">60 min</option>
          </select>
        </div>

        <button type="submit" [disabled]="sessionForm.invalid">
          Start Focus Session
        </button>
      </form>
    </section>

    <!-- RIGHT COLUMN: Activities + Placeholder Insights -->
    <section class="panel side-panel" *ngIf="!isInSession">
      <div class="activity-manager">
        <div class="panel-header">
          <h2>Your Activities</h2>
          <p>Define the work contexts that shape your focus profile.</p>
        </div>

        <form
          [formGroup]="activityForm"
          (ngSubmit)="onAddActivity()"
          class="activity-form"
        >
          <input
            type="text"
            formControlName="name"
            placeholder="e.g. Backend Coding, UI Design, Exam Prep"
          />
          <button type="submit" [disabled]="activityForm.invalid">Add</button>
        </form>

        <ul class="activity-list">
          <li *ngFor="let activity of activities">
            <span>{{ activity.name }}</span>
            <button type="button" (click)="onDeleteActivity(activity.id)">
              Remove
            </button>
          </li>
          <li *ngIf="activities.length === 0" class="empty">
            No activities added yet. Start by defining one.
          </li>
        </ul>
      </div>

      <div class="insights-placeholder">
        <h3>Focus Insights (soon)</h3>
        <p>
          Here you'll see your best focus recipes:
          <span class="highlight">activities Ã— moods Ã— soundscapes</span>.
        </p>
      </div>
    </section>

    <!-- ACTIVE SESSION VIEW -->
    <ng-template #sessionActiveTemplate>
      <section class="panel session-panel">
        <div class="panel-header">
          <h2>Focus Session Active</h2>
          <p>
            Stay in the zone. Your music and timer are synced with your goal.
          </p>
        </div>

        <div class="session-grid">
          <div class="timer-card">
            <h3>Session Timer</h3>
            <div class="timer-display">
              <span class="label">Remaining</span>
              <span class="time">{{ displayTime }}</span>
            </div>
          </div>

          <div
            class="spotify-card"
            *ngIf="currentPlaylistEmbedUrl; else noPlaylist"
          >
            <h3>Spotify Playlist</h3>
            <p class="subtitle">Curated for this focus session.</p>
            <iframe
              [src]="currentPlaylistEmbedUrl | safeUrl"
              width="100%"
              height="360"
              frameborder="0"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
            ></iframe>
          </div>

          <ng-template #noPlaylist>
            <div class="spotify-card empty">
              <h3>No playlist received</h3>
              <p>
                We couldn't fetch a Spotify playlist for this session. You can
                still stay focused â€” or try starting a new session.
              </p>
            </div>
          </ng-template>
        </div>

        <div class="session-actions">
          <button class="end-btn" (click)="onEndSession()">End Session</button>
        </div>
      </section>
    </ng-template>
  </main>
</div>
